<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>정산 · 메시지 대시보드</title>
    <link rel="stylesheet" th:href="@{/css/whole-process-dashboard.css}">
</head>
<body>
<div class="container">
    <h1>정산 · 메시지 대시보드</h1>

    <!-- ================= 총 데이터 ================= -->
    <div class="card">
        <div class="month">
            정산월: <span id="settlementMonth">2026-01</span>
        </div>
        <div class="step-row">
            <span class="step-name">
                총 데이터
                <small>
                    <span class="totalCount">0</span>건
                </small>
            </span>
        </div>
    </div>

    <!-- ================= 배치 프로세스 ================= -->
    <div class="card">
        <!-- Batch Job -->
        <div class="step-row">
            <span class="step-name">
                Batch Job 진행 상태
                <small>
                    ( <span id="batchCount">0</span>
                    / <span class="totalCount">0</span> )
                    · <span class="batchRate">0</span>%
                </small>
            </span>
            <span id="batchJob" class="status waited"></span>
        </div>
        <div class="bar-wrap">
            <div id="bar-batchJob" class="bar wait" style="width:0%"></div>
        </div>

        <!-- Kafka Sent -->
        <div class="step-row">
            <span class="step-name">
                Kafka Sent 진행 상태
                <small>
                    ( <span id="kafkaSentCount">0</span>
                    / <span class="totalCount">0</span> )
                    · <span class="kafkaSentRate">0</span>%
                </small>
            </span>
            <span id="batchKafkaSent" class="status waited"></span>
        </div>
        <div class="bar-wrap">
            <div id="bar-batchKafkaSent" class="bar wait" style="width:0%"></div>
        </div>
    </div>

    <!-- ================= 메시지 프로세스 ================= -->
    <div class="card">
        <!-- Kafka Receive -->
        <div class="step-row">
            <span class="step-name">
                Kafka Receive 진행 상태
                <small>
                    ( <span id="kafkaReceiveCount">0</span>
                    / <span class="totalCount">0</span> )
                    · <span class="kafkaReceiveRate">0</span>%
                </small>
            </span>
            <span id="messageKafkaReceive" class="status waited"></span>
        </div>
        <div class="bar-wrap">
            <div id="bar-messageKafkaReceive" class="bar wait" style="width:0%"></div>
        </div>

        <!-- Create Message -->
        <div class="step-row">
            <span class="step-name">
                Create Message 진행 상태
                <small>
                    ( <span id="createMessageCount">0</span>
                    / <span class="totalCount">0</span> )
                    · <span class="createMessageRate">0</span>%
                </small>
            </span>
            <span id="messageCreateMessage" class="status waited"></span>
        </div>
        <div class="bar-wrap">
            <div id="bar-messageCreateMessage" class="bar wait" style="width:0%"></div>
        </div>

        <!-- Sent Message -->
        <div class="step-row">
            <span class="step-name">
                Sent Message 진행 상태
                <small>
                    ( <span id="sentMessageCount">0</span>
                    / <span class="totalCount">0</span> )
                    · <span class="sentMessageRate">0</span>%
                </small>
            </span>
            <span id="messageSentMessage" class="status waited"></span>
        </div>
        <div class="bar-wrap">
            <div id="bar-messageSentMessage" class="bar wait" style="width:0%"></div>
        </div>
    </div>
</div>

<script>
/* ================= 상태 한글 매핑 ================= */
const STATUS_LABEL = {
    WAITED: '대기',
    PENDING: '진행 중',
    DONE: '완료',
    FAIL: '실패'
};

/* ================= 상태 업데이트 ================= */
function updateStatus(id, statusStr) {
    const el = document.getElementById(id);
    if (!el) return;

    const status = (statusStr ?? 'WAITED').toUpperCase();
    el.textContent = STATUS_LABEL[status] ?? '대기';

    el.classList.remove('waited', 'pending', 'done', 'fail');
    el.classList.add(status.toLowerCase());
}

/* ================= 진행률 바 업데이트 ================= */
function updateBar(barId, rate) {
    const bar = document.getElementById(barId);
    if (!bar) return;

    const value = Math.max(0, Math.min(rate ?? 0, 100));
    bar.style.width = value + '%';

    bar.classList.remove('wait', 'pending', 'done', 'fail');
    if (value === 0) bar.classList.add('wait');
    else if (value < 100) bar.classList.add('pending');
    else bar.classList.add('done');
}

/* ================= 클래스 단일 적용 ================= */
function updateClassText(className, value) {
    document.querySelectorAll(`.${className}`).forEach(el => {
        el.textContent = value;
    });
}

/* ================= 안전한 textContent ================= */
function safeSetText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
}

/* ================= SSE ================= */
document.addEventListener('DOMContentLoaded', function() {
    const eventSource = new EventSource('/admin/process/stream');

    eventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);

            // ================= 상태 업데이트 =================
            if (data.batchJob !== undefined) updateStatus('batchJob', data.batchJob);
            if (data.batchKafkaSent !== undefined) updateStatus('batchKafkaSent', data.batchKafkaSent);
            if (data.messageKafkaReceive !== undefined) updateStatus('messageKafkaReceive', data.messageKafkaReceive);
            if (data.messageCreateMessage !== undefined) updateStatus('messageCreateMessage', data.messageCreateMessage);
            if (data.messageSentMessage !== undefined) updateStatus('messageSentMessage', data.messageSentMessage);

            // ================= 진행률 바 업데이트 =================
            if (data.batchRate !== undefined) updateBar('bar-batchJob', data.batchRate);
            if (data.kafkaSentRate !== undefined) updateBar('bar-batchKafkaSent', data.kafkaSentRate);
            if (data.kafkaReceiveRate !== undefined) updateBar('bar-messageKafkaReceive', data.kafkaReceiveRate);
            if (data.createMessageRate !== undefined) updateBar('bar-messageCreateMessage', data.createMessageRate);
            if (data.sentMessageRate !== undefined) updateBar('bar-messageSentMessage', data.sentMessageRate);

            // ================= 텍스트 값 업데이트 =================
            if (data.totalCount !== undefined) updateClassText('totalCount', data.totalCount);
            if (data.batchRate !== undefined) updateClassText('batchRate', data.batchRate.toFixed(2));
            if (data.kafkaSentRate !== undefined) updateClassText('kafkaSentRate', data.kafkaSentRate.toFixed(2));
            if (data.kafkaReceiveRate !== undefined) updateClassText('kafkaReceiveRate', data.kafkaReceiveRate.toFixed(2));
            if (data.createMessageRate !== undefined) updateClassText('createMessageRate', data.createMessageRate.toFixed(2));
            if (data.sentMessageRate !== undefined) updateClassText('sentMessageRate', data.sentMessageRate.toFixed(2));

            if (data.settlementMonth !== undefined) safeSetText('settlementMonth', data.settlementMonth);
            if (data.batchCount !== undefined) safeSetText('batchCount', data.batchCount);
            if (data.kafkaSentCount !== undefined) safeSetText('kafkaSentCount', data.kafkaSentCount);
            if (data.kafkaReceiveCount !== undefined) safeSetText('kafkaReceiveCount', data.kafkaReceiveCount);
            if (data.createMessageCount !== undefined) safeSetText('createMessageCount', data.createMessageCount);
            if (data.sentMessageCount !== undefined) safeSetText('sentMessageCount', data.sentMessageCount);

        } catch (e) {
            console.error('SSE 업데이트 오류:', e);
        }
    };

    eventSource.onerror = function(err) {
        console.error('SSE 연결 오류:', err);
    };
});
</script>


</body>
</html>
