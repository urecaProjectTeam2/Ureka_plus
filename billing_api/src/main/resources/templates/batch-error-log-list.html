<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Error Diagnosis</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .user-id-link { color: #0d6efd; text-decoration: underline; cursor: pointer; }
        .user-id-link:hover { color: #0a58ca; }
    </style>
</head>
<body class="bg-light">
<div class="container py-5">
    <div class="d-flex justify-content-between mb-4 border-bottom pb-3">
        <h3 class="fw-bold"><span class="text-danger">#[[${jobId}]]</span> 잡 에러 상세 진단</h3>
        <a th:href="@{/admin/batch/dashboard}" class="btn btn-sm btn-secondary">대시보드 복귀</a>
    </div>

    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
            <div class="input-group">
                <span class="input-group-text bg-white">User ID 검색</span>
                <input type="number" id="userSearchInput" class="form-control" th:value="${searchUserId}" placeholder="유저 ID 입력">
                <button class="btn btn-primary" onclick="searchByUserId()">조회</button>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <table class="table table-hover mb-0 bg-white text-center">
            <thead class="table-danger small">
            <tr><th>User ID (클릭 시 팝업)</th><th>타입</th><th>메시지</th><th>시간</th></tr>
            </thead>
            <tbody>
            <tr th:each="err : ${errors}">
                <td>
                        <span class="fw-bold user-id-link"
                              th:onclick="|showUserModal(${err.userId})|"
                              th:text="${err.userId}"></span>
                </td>
                <td th:text="${err.errorType}"></td>
                <td th:text="${err.errorMessage}" class="text-start text-wrap"></td>
                <td th:text="${#temporals.format(err.occurredAt, 'HH:mm:ss')}"></td>
            </tr>
            <tr th:if="${#lists.isEmpty(errors)}">
                <td colspan="4" class="py-5 text-muted">에러 내역이 없습니다.</td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h6 class="modal-title">사용자 정보</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div id="modalContent" class="modal-body p-4 text-center">로딩 중...</div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    function searchByUserId() {
        const userId = document.getElementById('userSearchInput').value;
        location.href = `/admin/batch/error/search?jobId=[[${jobId}]]&userId=${userId}`;
    }

    function showUserModal(userId) {
        new bootstrap.Modal(document.getElementById('userModal')).show();
        fetch(`/api/users/${userId}`)
            .then(res => res.json())
            .then(user => {
                document.getElementById('modalContent').innerHTML = `
                    <div class="text-start small">
                        <b>이름:</b> ${user.userName}<br>
                        <b>이메일:</b> ${user.email}<br>
                        <b>상태:</b> <span class="text-success fw-bold">${user.status}</span>
                    </div>`;
            });
    }
</script>
</body>
</html>