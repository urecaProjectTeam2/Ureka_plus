<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>To U+ | Billing Tower</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/batch-dashboard.css}">
</head>
<body>

<div th:replace="~{layout/sidebar :: sidebar}"></div>
<div class="main-content">
    <h2>Î∞∞Ïπò Î™®ÎãàÌÑ∞ÎßÅ</h2>

    <div id="liveArea" class="monitor-card inactive-monitor">
        <div id="liveHeader" class="card-header bg-secondary">
            <div>
                <span id="statusDot" class="status-dot dot-offline"></span>
                <span id="statusText">Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...</span>
            </div>
            <div id="lastSuccessInfo" th:if="${lastSuccess != null}" style="font-size: 0.8rem; opacity: 0.9;">
                ÏµúÏ¢Ö ÏÑ±Í≥µ: #[[${lastSuccess.JOB_EXECUTION_ID}]] ([[${lastSuccess.END_TIME}]])
            </div>
        </div>

        <div class="card-body">
            <div class="progress-wrapper">
                <div class="progress-outer">
                    <div id="progressBar" class="progress-inner">0%</div>
                </div>
                <div style="min-width: 120px; text-align: right;">
                    <span id="processedCount" style="font-weight: 800; font-size: 1.2rem;">0</span>
                    <span style="color: #6c757d; font-size: 0.9rem;">/ 1,000,000</span>
                </div>
            </div>

            <div class="metrics-container">
                <div class="metric-box">
                    <div class="metric-label">TPS</div>
                    <div id="tpsValue" class="metric-value text-primary">0.0</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">ETC (ÎÇ®ÏùÄ ÏãúÍ∞Ñ)</div>
                    <div id="etcValue" class="metric-value text-success">00:00:00</div>
                </div>
                <div class="metric-box" id="skipCard">
                    <div class="metric-label">Skip</div>
                    <div id="skipCount" class="metric-value text-danger">0</div>
                </div>
            </div>

            <div id="partitionGrid" class="partition-grid">
            </div>
        </div>
    </div>

    <div id="historyTableContainer" th:fragment="history-table-content" class="history-card">
        <div class="history-header">ÏµúÍ∑º Î∞∞Ïπò Ïã§Ìñâ Ïù¥Î†•</div>
        <table>
            <thead>
            <tr>
                <th>ID</th><th>ÏÉÅÌÉú</th><th>ÏãúÏûë ÏãúÍ∞Ñ</th><th>Ï≤òÎ¶¨ Í±¥Ïàò</th><th>ÏÜåÏöî ÏãúÍ∞Ñ</th><th>Ïä§ÌÇµ Í±¥Ïàò</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="h : ${historyList}">
                <td th:text="${h.executionId}" style="color: var(--primary-color); font-weight: bold;"></td>
                <td style="min-width: 120px;">
                    <div th:if="${h.exitCode != null}" th:switch="${h.exitCode}">
                        <span th:case="'FAILED'" class="badge badge-danger">FAILED</span>
                        <span th:case="'UNKNOWN'" class="badge badge-secondary">TERMINATED</span>
                        <span th:case="*"
                              th:text="${h.status}"
                              th:class="'badge ' + (${h.status == 'COMPLETED' ? 'badge-success' : 'badge-warning'})">
                        </span>
                    </div>
                    <div th:if="${h.exitCode == null}">
                        <span th:text="${h.status}"
                              th:class="'badge ' + (${h.status == 'COMPLETED' ? 'badge-success' : 'badge-warning'})">
                        </span>
                    </div>
                </td>
                <td th:text="${#temporals.format(h.startTime, 'MM-dd HH:mm:ss')}"></td>
                <td th:text="${#numbers.formatInteger(h.totalWrite, 0, 'COMMA')}" style="font-weight: bold;"></td>
                <td th:text="${h.duration + 'Ï¥à'}"></td>
                <td>
                    <div th:if="${h.skipCount > 0}">
                        <a th:href="@{/admin/batch/error/list/{id}(id=${h.executionId})}"
                           class="btn-detail">
                            [[${h.skipCount}]]Í±¥ (ÏÉÅÏÑ∏)
                        </a>
                    </div>
                    <span th:unless="${h.skipCount > 0}" style="color: #adb5bd;">0</span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script th:inline="javascript">
    /* [ÏõêÎ≥∏ Î°úÏßÅ 100% Ïú†ÏßÄ] */
    const eventSource = new EventSource('/admin/batch/realtime/stream');
    let targetProgress = 0, displayProgress = 0, interpolationTimer = null, currentTps = 0;
    const TOTAL_COUNT = 1000000;

    eventSource.addEventListener("batchUpdate", (event) => {
        const data = JSON.parse(event.data);
        console.log("==> SSE ÏàòÏã† Îç∞Ïù¥ÌÑ∞:", data);
        const liveArea = document.getElementById('liveArea');
        const liveHeader = document.getElementById('liveHeader');
        const pb = document.getElementById('progressBar');
        const skipCard = document.getElementById('skipCard');

        if (!data.isCompleted) {
            liveArea.classList.remove('inactive-monitor');
            liveHeader.classList.remove('bg-secondary');
            liveHeader.classList.add('bg-primary');
            document.getElementById('statusDot').className = 'status-dot dot-online';
            document.getElementById('statusText').textContent = "Î∞∞Ïπò Job Î™®ÎãàÌÑ∞ÎßÅ";
            document.getElementById('liveHeader').className = 'card-header bg-primary';

            // [2] Î°úÎî©Î∞î ÏÉâÏÉÅ Ï†úÏñ¥
            if (data.skipCount > 0) {
                pb.classList.add('bg-danger', 'animated-stripes'); // ÏóêÎü¨ Ïãú Îπ®Í∞ÑÏÉâ
                skipCard.style.cursor = 'pointer';
                skipCard.onclick = () => location.href = `/admin/batch/error/list/${data.currentJobId}`;
            } else {
                pb.classList.remove('bg-danger'); // ÌèâÏÜåÏóî CSSÏóê Ï†ïÏùòÎêú Î≥¥ÎùºÏÉâ Ï†ÅÏö©
                pb.classList.remove('bg-secondary');
                pb.classList.add('animated-stripes');
            }

            targetProgress = parseFloat((data.progress || "0%").replace('%', ''));
            currentTps = data.tps || 0;
            if (displayProgress === 0) displayProgress = targetProgress;

            document.getElementById('processedCount').textContent = (data.totalProcessed || 0).toLocaleString();
            document.getElementById('tpsValue').textContent = (data.tps || 0).toLocaleString();
            document.getElementById('etcValue').textContent = data.etc || "00:00:00";
            document.getElementById('skipCount').textContent = (data.skipCount || 0).toLocaleString();

            if(data.partitions) {
                document.getElementById('partitionGrid').innerHTML = data.partitions.map(p => `
                    <div class="partition-item">
                        <div style="color: #888; margin-bottom: 4px;">${p.stepName.split(':').pop()}</div>
                        <div style="font-weight: 800; color: ${p.skipCount > 0 ? 'var(--danger-color)' : 'var(--primary-color)'}">${p.writeCount.toLocaleString()}</div>
                    </div>
                `).join('');
            }
            if (!interpolationTimer) startInterpolation();
        } else {
            stopMonitoring("Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...");
        }
    });

    function startInterpolation() {
        interpolationTimer = setInterval(() => {
            const pb = document.getElementById('progressBar');

            // üéØ [ÏàòÏ†ï] TPSÍ∞Ä 0Î≥¥Îã§ ÌÅ¥ ÎïåÎßå ÏµúÏÜå Ï†ÑÏßÑ(0.001)ÏùÑ ÌóàÏö©Ìï©ÎãàÎã§.
            // Î∞∞ÏπòÍ∞Ä Ïïà ÎèåÎ©¥(currentTps === 0) incrementalStepÎèÑ 0Ïù¥ Îê©ÎãàÎã§.
            const incrementalStep = currentTps > 0 ? Math.max((currentTps / TOTAL_COUNT) * 10, 0.001) : 0;

            if (displayProgress < targetProgress) {
                // Î™©ÌëúÏπò Ï∂îÍ≤© (ÎÑêÎõ∞Í∏∞ Î∞©ÏßÄ)
                displayProgress += (targetProgress - displayProgress) * 0.05;
            } else if (currentTps > 0) {
                // Î™©ÌëúÏπò ÎèÑÎã¨ ÌõÑÏóêÎäî TPS Í∏∞Î∞òÏúºÎ°ú ÎØ∏ÏÑ∏ Ï†ÑÏßÑ
                displayProgress += incrementalStep;
            }

            // 100% Í∑ºÏ≤òÏóêÏÑú Î©àÏ∂§ Ï≤òÎ¶¨
            if (displayProgress > 99.99 && targetProgress < 100) displayProgress = 99.99;

            const finalVal = displayProgress.toFixed(2);
            pb.style.width = finalVal + '%';
            pb.innerText = finalVal + '%';

            if (displayProgress >= 100) pb.classList.remove('animated-stripes');
        }, 100);
    }

    // üéØ [Ï§ëÏöî] Î∞∞ÏπòÍ∞Ä Ï¢ÖÎ£åÎêòÏóàÏùÑ Îïå Ìò∏Ï∂úÎêòÎäî Ìï®ÏàòÏóêÏÑú Îç∞Ïù¥ÌÑ∞ ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî
    function stopMonitoring(msg) {
        if (interpolationTimer) {
            clearInterval(interpolationTimer);
            interpolationTimer = null;
        }

        // 1. Î™®Îì† Í≥ÑÏÇ∞Ïö© ÏàòÏπò ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî (Ïà´ÏûêÍ∞Ä Ïò¨ÎùºÍ∞ÄÎäî Í≤É Î∞©ÏßÄ)
        currentTps = 0;
        targetProgress = 0;
        displayProgress = 0;

        const liveArea = document.getElementById('liveArea');
        const liveHeader = document.getElementById('liveHeader');
        const pb = document.getElementById('progressBar');

        // 2. Î≥¥ÎùºÏÉâ(bg-primary)ÏùÑ ÌöåÏÉâ(bg-secondary)ÏúºÎ°ú ÍµêÏ≤¥
        liveArea.classList.add('inactive-monitor');
        liveHeader.classList.remove('bg-primary');
        liveHeader.classList.add('bg-secondary');

        // 3. Î∞îÏôÄ ÌÖçÏä§Ìä∏Î•º 0ÏúºÎ°ú Í≥†Ï†ï
        pb.style.width = '0%';
        pb.innerText = '0%';
        pb.classList.remove('bg-danger', 'animated-stripes');

        document.getElementById('statusDot').className = 'status-dot dot-offline';
        document.getElementById('statusText').textContent = msg;

        // ÏßÄÌëú ÌÖçÏä§Ìä∏Îì§ÎèÑ 0ÏúºÎ°ú Î¶¨ÏÖã
        document.getElementById('processedCount').textContent = '0';
        document.getElementById('tpsValue').textContent = '0.0';
        document.getElementById('etcValue').textContent = '00:00:00';
        document.getElementById('skipCount').textContent = '0';
    }

    eventSource.addEventListener("finished", (event) => {
        targetProgress = 100;
        document.getElementById('statusText').textContent = "Ï†ïÏÇ∞ ÏôÑÎ£å";
        document.getElementById('statusDot').className = 'status-dot dot-success';
        document.getElementById('progressBar').classList.remove('animated-stripes');
        document.getElementById('partitionGrid').innerHTML = '';
        fetch('/admin/batch/dashboard/history-fragment')
            .then(res => res.text())
            .then(html => { document.getElementById('historyTableContainer').innerHTML = html; });
    });
</script>
</body>
</html>