<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>사용자 정산 결과 | 관리자</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/billing-result.css}">
</head>
<body>

<div th:replace="~{layout/sidebar :: sidebar}"></div>

<div class="container">
    <h1> 사용자 정산 결과 </h1>
   <span class="step-card">
	    <i class="bi bi-calendar-event"></i>
	    정산월: <span id="settlementMonth" th:text="${settlementMonthStr}">--</span>
	</span>
    <div class="table-responsive">
        <table class="template-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>이름</th>
                <th>전화번호</th>
                <th>이메일</th>
                <th>구독 상품</th>
                <th>정산 상태</th>
                <th>정산 금액</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="user : ${settlements.contents}">
                <td th:text="${user.user.userId}"></td>
                <td th:text="${user.user.name}"></td>
                <td th:text="${user.user.phone}"></td>
                <td th:text="${user.user.email}"></td>

                <td th:unless="${#lists.isEmpty(user.details)}">
                    <button class="btn-primary" type="button"
                            th:onclick="'fillSettlementModal(' + ${user.user.userId} + ')'">
                        전체 상세보기
                    </button>

                    <div th:id="'modalContent_' + ${user.user.userId}" style="display:none">
                        <table class="modal-table">
                            <thead>
                            <tr><th>상품명</th><th>가격</th></tr>
                            </thead>
                            <tbody>
                            <tr th:each="prod : ${user.details}">
                                <td class="content-cell" th:text="${prod.productName}"></td>
                                <td th:text="${prod.price}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </td>

                <td>
                    <span th:if="${user.billed}" class="badge bg-success">정산 완료</span>
                    <span th:unless="${user.billed}" class="badge bg-secondary">미정산</span>
                </td>
                <td th:text="${user.totalPrice != null ? user.totalPrice : 0}"></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ================= 페이징 ================= -->
    <div class="pagination-container">
        <a th:href="@{/admin/users/settlements(settlementMonth=${settlementMonthStr}, page=${currentPage > 0 ? currentPage-1 : 0})}"
           th:classappend="${currentPage==0}?'disabled':''" class="btn-pagination">이전</a>

        <span class="pagination-info">페이지 <span th:text="${currentPage + 1}"></span> / <span th:text="${settlements.totalPages}"></span></span>

        <a th:href="@{/admin/users/settlements(settlementMonth=${settlementMonthStr}, page=${currentPage+1 < settlements.totalPages ? currentPage+1 : currentPage})}"
           th:classappend="${currentPage+1>=settlements.totalPages}?'disabled':''" class="btn-pagination">다음</a>
    </div>
</div>

<!-- ================= 모달 ================= -->
<div class="modal" id="settlementModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">정산 상세 내역</h5>
                <button class="btn-close" id="modalCloseBtn">&times;</button>
            </div>
            <div class="modal-body" id="settlementDetailBody">로딩 중...</div>
        </div>
    </div>
</div>

<script>
    const modal = document.getElementById('settlementModal');
    const modalBody = document.getElementById('settlementDetailBody');
    const closeBtn = document.getElementById('modalCloseBtn');

    function fillSettlementModal(userId) {
        const content = document.getElementById(`modalContent_${userId}`);
        if(content) {
            modalBody.innerHTML = content.innerHTML;
            modal.style.display = 'block';
        }
    }

    closeBtn.addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', (e) => { if(e.target===modal) modal.style.display='none'; });
</script>
</body>
</html>