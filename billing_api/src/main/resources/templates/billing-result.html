<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì‚¬ìš©ì ì •ì‚° ê²°ê³¼ | ê´€ë¦¬ì</title>

    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/admin-settlement.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div th:replace="~{layout/sidebar :: sidebar}"></div>

<div class="container-fluid" style="margin-left: 260px; padding-top: 30px;">
    <h1>
        ğŸ“‹ ì‚¬ìš©ì ì •ì‚° ê²°ê³¼ -
        <span th:text="${settlementMonthStr}"></span>
    </h1>

    <div class="table-responsive mt-4">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>ì´ë¦„</th>
                <th>ì „í™”ë²ˆí˜¸</th>
                <th>ì´ë©”ì¼</th>
                <th>êµ¬ë… ìƒí’ˆ</th>
                <th>ì •ì‚° ìƒíƒœ</th>
                <th>ì •ì‚° ê¸ˆì•¡</th>
            </tr>
            </thead>

            <tr th:each="user : ${settlements.contents}" style="cursor: default">
                <td th:text="${user.user.userId}"></td>
                <td th:text="${user.user.name}"></td>
                <td th:text="${user.user.phone}"></td>
                <td th:text="${user.user.email}"></td>

                <td th:unless="${#lists.isEmpty(user.details)}">
                    <button class="btn btn-sm btn-primary" type="button"
                            th:attr="data-bs-toggle='modal', data-bs-target='#settlementModal'"
                            th:onclick="'fillSettlementModal(' + ${user.user.userId} + ')'">
                        ì „ì²´ ìƒì„¸ë³´ê¸°
                    </button>

                    <!-- hidden fragment -->
                    <div th:id="'modalContent_' + ${user.user.userId}" style="display:none">
                        <table class="table table-bordered">
                            <thead>
                            <tr><th>ìƒí’ˆëª…</th><th>ê°€ê²©</th></tr>
                            </thead>
                            <tbody>
                            <tr th:each="prod : ${user.details}">
                                <td th:text="${prod.productName}"></td>
                                <td th:text="${prod.price}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </td>


                <!-- ì •ì‚° ìƒíƒœ -->
                <td>
                    <span th:if="${user.billed}" class="badge bg-success">ì •ì‚° ì™„ë£Œ</span>
                    <span th:unless="${user.billed}" class="badge bg-secondary">ë¯¸ì •ì‚°</span>
                </td>

                <!-- ì •ì‚° ê¸ˆì•¡ -->
                <td th:text="${user.totalPrice != null ? user.totalPrice : 0}"></td>
            </tr>

        </table>
    </div>

    <!-- í˜ì´ì§• -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/admin/users/settlements(settlementMonth=${settlementMonthStr}, page=${currentPage > 0 ? currentPage - 1 : 0})}">
                    ì´ì „
                </a>
            </li>

            <li class="page-item disabled">
                <span class="page-link">
                    í˜ì´ì§€ <span th:text="${currentPage + 1}"></span>
                    /
                    <span th:text="${settlements.totalPages}"></span>
                </span>
            </li>

            <li class="page-item"
                th:classappend="${currentPage + 1 >= settlements.totalPages} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/admin/users/settlements(settlementMonth=${settlementMonthStr}, page=${currentPage + 1 < settlements.totalPages ? currentPage + 1 : currentPage})}">
                    ë‹¤ìŒ
                </a>
            </li>
        </ul>
    </nav>
</div>
<div class="modal fade" id="settlementModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì •ì‚° ìƒì„¸ ë‚´ì—­</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div id="settlementDetailBody">
                    ë¡œë”© ì¤‘...
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<script>
    document.addEventListener('DOMContentLoaded', () => {
    const closeBtn = document.querySelector('#settlementModal .btn-close');
    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            const modalEl = document.getElementById('settlementModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) {
                modal.hide();
            }

            // backdrop ì œê±°
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) backdrop.remove();
        });
    }
});

    function fillSettlementModal(userId) {
        const modalBody = document.querySelector('#settlementModal .modal-body');
        const content = document.querySelector(`#modalContent_${userId}`);
        if(modalBody && content){
            modalBody.innerHTML = content.innerHTML;
            const modal = new bootstrap.Modal(document.getElementById('settlementModal'));
            modal.show();
        }
    }
</script>
