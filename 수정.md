# Docker 설정 수정 내역

## 1️⃣ MySQL 포트 변경 (docker-compose.yml)

```yaml
# 변경 전
ports:
  - "3306:3306"

# 변경 후
ports:
  - "3307:3306"
```

**이유:** 로컬 MySQL과 포트 충돌 방지

---

## 2️⃣ Kafka 리스너 설정 추가 (docker-compose.yml)

```yaml
# 변경 전
KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9092

# 변경 후
KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,PLAINTEXT_HOST://0.0.0.0:9092
KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
```

**이유:** 두 리스너가 같은 포트(9092) 사용해서 충돌

---

## 3️⃣ 애플리케이션 Kafka 포트 변경 (docker-compose.yml)

```yaml
# 변경 전
SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

# 변경 후
SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
```

**적용 대상:** billing-batch, billing-message

---

## 4️⃣ .dockerignore 파일 생성 (신규)

```
data/
.git/
.idea/
*.log
build/
.gradle/
```

**이유:** MySQL 데이터 폴더(`data/mysql/mysql.sock`)가 빌드 컨텍스트에 포함되어 오류 발생

---

## 요약

| 파일 | 변경 내용 |
|------|----------|
| `docker-compose.yml` | MySQL 포트 3307, Kafka 리스너 분리, 앱 Kafka 포트 29092 |
| `.dockerignore` | 신규 생성 (data/ 등 제외) |

---

## 5️⃣ MySQL healthcheck 추가 (docker-compose.yml)

```yaml
mysql:
  healthcheck:
    test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
    interval: 10s
    timeout: 5s
    retries: 5
```

**이유:** MySQL이 완전히 준비된 후 앱이 시작되도록 함

---

## 6️⃣ Spring 프로필 활성화 (docker-compose.yml)

```yaml
environment:
  SPRING_PROFILES_ACTIVE: docker
```

**적용 대상:** billing-api, billing-batch, billing-message

**이유:** Docker 환경에서 `application-docker.yml` 설정 사용

---

## 7️⃣ depends_on 조건 추가 (docker-compose.yml)

**billing-api:**
```yaml
depends_on:
  mysql:
    condition: service_healthy
  redis:
    condition: service_started
```

**billing-batch:**
```yaml
depends_on:
  mysql:
    condition: service_healthy
  kafka:
    condition: service_started
```

**billing-message:**
```yaml
depends_on:
  mysql:
    condition: service_healthy
  kafka:
    condition: service_started
  redis:
    condition: service_started
```

**이유:** MySQL이 healthy 상태가 된 후에만 앱 시작

---

## 최종 요약

| 파일 | 변경 내용 |
|------|----------|
| `docker-compose.yml` | MySQL 포트 3307, Kafka 리스너 분리, 앱 Kafka 포트 29092, healthcheck, Spring 프로필, depends_on 조건 |
| `.dockerignore` | 신규 생성 (data/ 등 제외) |
