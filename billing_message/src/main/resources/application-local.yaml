# application-local.yml
spring:
  config:
    activate:
      on-profile: local # 이 설정은 'local' 프로필일 때만 작동함
  task:
    scheduling:
      pool:
        size: 10  # 스케줄러 스레드 풀 (기본값 1 → 10)
  jpa:
    properties:
      hibernate:
        jdbc:
          batch_size: 1000
        order_inserts: true
        order_updates: true

  datasource:
    # 도커 내부(host.docker.internal)가 아니라 내 컴퓨터(localhost)로 접속
    url: jdbc:mysql://localhost:13306/billing_message?rewriteBatchedStatements=true&useServerPrepStmts=true&cachePrepStmts=true
    username: ${DB_USER}
    password: ${DB_PASSWORD}
    hikari:
      maximum-pool-size: 50   # DB 작업용
      minimum-idle: 25        # 유휴 커넥션 유지

  # Redis (Docker: localhost:6379)
  data:
    redis:
      host: localhost
      port: 6379

  kafka:
    # 도커 서비스명(kafka:29092)이 아니라 내 컴퓨터 포트(localhost:9092)로 접속
    bootstrap-servers: localhost:9092
    # [수정] 터널링 환경에 맞춰 SASL 인증 설정 제거 (이미 SSH로 보안 통로가 확보됨)
    # security.protocol 및 sasl 관련 설정 삭제

    consumer:
      group-id: billing-message-groupM19
      auto-offset-reset: earliest
      enable-auto-commit: false # 수동 커밋 모드 (안정성 확보)
      max-poll-records: 2500      # poll 처리 시간을 짧게 유지
      max-poll-interval-ms: 1800000  # 처리 시간이 길어도 리밸런스 방지 (30분)
      session-timeout-ms: 60000      # poll 지연 시 세션 유지
      heartbeat-interval-ms: 20000   # 세션 유지용 하트비트
      # [추가] Deserializer 설정 (batch 모듈과 쌍을 맞춰야 데이터가 읽힙니다)
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer

      properties:
        # [추가] 역직렬화 시 신뢰할 수 있는 패키지 지정 (에러 방지)
        spring.json.trusted.packages: "com.touplus.billing_batch.domain.dto,com.touplus.billing_message.domain.dto"
        # 대량 처리를 위한 성능 옵션
        fetch.min.bytes: 1        # 즉시 응답
        fetch.max.wait.ms: 100    # 최대 100ms 대기

    listener:
      # 컨슈머가 수동으로 커밋할 수 있도록 설정 (AckMode)
      ack-mode: manual_immediate
      idle-between-polls: 100     # 빈 토픽일 때 과도 폴링 방지
      
message:
  dispatch:
    pool-size: 500            # 배치 크기와 동일 (1배치=1초)
    queue-size: 1500
    batch-size: 500           # pool-size와 동일
    poll-delay-ms: 300        # 더 빠른 폴링
    worker-count: 50          # DelayQueue 워커 스레드 수

    # 암호화 키 (환경변수에서 읽음)
    crypto:
      fernet:
        key: ${FERNET_KEY}
