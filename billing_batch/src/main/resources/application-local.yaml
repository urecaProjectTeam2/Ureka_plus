# application-local.yml
spring:
  config:
    activate:
      on-profile: local

  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:13306/billing_batch
    username: ${DB_USER} #로컬로 테스트 시, 직접 값 입력하기
    password: ${DB_PASSWORD} #로컬로 테스트 시, 직접 값 입력하기
    hikari:
      maximum-pool-size: 50

  # 배치 메타데이터 테이블 자동 생성 및 자동 실행 방지
  batch:
    jdbc:
      initialize-schema: always
    job:
      enabled: false

  kafka:
    bootstrap-servers: localhost:9092
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      # [추가] 500만 건 전송 시 발생할 수 있는 타임아웃 방지 && 네트워크 부하가 높을 때 전송 요청이 만료되지 않도록 시간을 넉넉히 잡습니다.
      retries: 5
      properties:
        linger.ms: 20       #20ms 동안 메시지를 모아서 한 번에 전송 (Throughput 향상)
        batch.size: 65536   #배치 크기를 64KB로 상향 (네트워크 요청 횟수 감소)
        compression.type: lz4 #lz4 압축으로 네트워크 대역폭 절약
        # 500만 건의 빌링 데이터는 유실 시 정산 금액 차이가 발생하므로 리더뿐만 아니라 복제본 저장까지 확인하는 'all' 설정
        acks: all
        # [추가] 한 번에 카프카로 보낼 수 있는 최대 요청 크기 (기본 1MB -> 5MB로 확장)
        max.request.size: 5242880

    consumer:
      group-id: billing-group
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "com.touplus.billing_batch.domain.dto"